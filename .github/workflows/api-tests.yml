name: API Tests with Newman

on:
  push:
    branches: [ main ]   # Runs on every push to main
  pull_request:
    branches: [ main ]   # Also on PRs to main

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '25'  # Node 25.x (Current) is stable and working well in your runs

      - name: Install dependencies
        run: npm install

      - name: Start backend server
        env:
          MONGO_URI: ${{ secrets.MONGO_URI }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          PORT: 5000
        run: |
          npm start &       # Start server in background
          sleep 15          # Give extra time for server & DB connection

      - name: Install Newman and HTML reporter
        run: |
          npm install -g newman
          npm install -g newman-reporter-html

      - name: Run API tests
        run: |
          newman run TestAPI/task-api-collection.json \
                     -e TestAPI/task-env.json \
                     --reporters cli,html \
                     --reporter-html-export newman/report.html

      - name: Upload test report
        if: always()  # Upload even if tests fail
        uses: actions/upload-artifact@v4
        with:
          name: newman-report
          path: newman/